{
    # Global options for logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 7d
        }
        format console
    }
}

localhost:443 {
    @users {
        path /users*
    }
    @posts {
        path /posts*
    }

    # Authentication
    forward_auth @users users-service:8080 {
        uri /verify
        copy_headers Authorization Cookie
    }
    forward_auth @posts users-service:8080 {
        uri /verify
        copy_headers Authorization Cookie
    }

    # CORS Headers
    header @users Access-Control-Allow-Origin "your-frontend-domain.com"
    header @users Access-Control-Allow-Credentials "true"
    header @users Access-Control-Allow-Headers "Authorization, Cookie"
    header @users Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"

    header @posts Access-Control-Allow-Origin "your-frontend-domain.com"
    header @posts Access-Control-Allow-Credentials "true"
    header @posts Access-Control-Allow-Headers "Authorization, Cookie"
    header @posts Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"

    # Users Service with Health Check
    handle_path /users* {
        reverse_proxy localhost:8080 {
            health_uri /healthz
            health_interval 10s
            health_timeout 2s
            health_status 200
        }
    }

    # Posts Service with Health Check
    handle_path /posts* {
        reverse_proxy localhost:8081 {
            health_uri /healthz
            health_interval 10s
            health_timeout 2s
            health_status 200
        }
    }
}