use {
    admin off
}

https://sm.com:443 {
    # Define routes that require JWT verification
    @protected_routes {
        not path /login /public/*  # Exclude login and public routes from verification
    }

    # Validate JWT from cookies before forwarding the request
    reverse_proxy @protected_routes http://localhost:8080/verify {
        header_up Cookie {http.request.header.Cookie}
    }

    # Handle 401 Unauthorized (JWT invalid or missing)
    handle_response 401 {
        redir https://auth.example.com/login
    }

    # Route for user service
    reverse_proxy /api/users/* user-service:8080 {
        lb_policy round_robin
        health_uri /
        health_status 2xx
        health_interval 5s
        health_timeout 2s
    }

    # Route for posts service
    reverse_proxy /api/posts/* posts-service:8081 {
        lb_policy round_robin
        health_uri /
        health_status 2xx
        health_interval 5s
        health_timeout 2s
    }

    # Route for notifications service
    reverse_proxy /api/notifications/* notifications-service:8082 {
        lb_policy round_robin
        health_uri /
        health_status 2xx
        health_interval 5s
        health_timeout 2s
    }
    
    # Route for activities service
    reverse_proxy /api/activities/* activities-service:8083 {
        lb_policy round_robin
        health_uri /
        health_status 2xx
        health_interval 5s
        health_timeout 2s
    }
}
